{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Transform": "AWS::Serverless-2016-10-31",
    "Description": "",
    "Resources": {
        "DataTable":{
            "Type":"AWS::DynamoDB::Table",
            "Properties":{
                "AttributeDefinitions": [{"AttributeName": "source","AttributeType": "S"},{"AttributeName": "timestamp","AttributeType": "N"}],
                "KeySchema": [{"AttributeName": "source","KeyType": "HASH"},{"AttributeName": "timestamp","KeyType": "RANGE"}],
                "BillingMode": "PAY_PER_REQUEST"
            }
        },
        "LambdaPolicy": {
            "Type": "AWS::IAM::ManagedPolicy",
            "Properties": {
                "Description": "",
                "Path": "/",
                "PolicyDocument": {
                    "Statement": [
                        {
                            "Action": [
                                "cloudwatch:*",
                                "logs:*"
                            ],
                            "Resource": "*",
                            "Effect": "Allow"
                        },
                        {
                            "Action": [
                                "dynamodb:Scan",
                                "dynamodb:Query",
                                "dynamodb:GetItem",
                                "dynamodb:PutItem",
                                "dynamodb:DeleteItem",
                                "dynamodb:UpdateItem",
                                "dynamodb:BatchGetItem",
                                "dynamodb:BatchWriteItem",
                                "dynamodb:Describe*",
                                "dynamodb:List*"
                            ],
                            "Resource": [
                                { "Fn::Sub" : "arn:${AWS::Partition}:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${DataTable}"},
                                { "Fn::Sub" : "arn:${AWS::Partition}:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${DataTable}/*"}
                            ],
                            "Effect": "Allow"
                        },
                        {
                            "Action": [
                                "cloudformation:Describe*",
                                "cloudformation:Get*",
                                "cloudformation:List*"
                            ],
                            "Resource": [
                                {"Ref":"AWS::StackId"},
                                { "Fn::Sub" : "arn:${AWS::Partition}:cloudformation:${AWS::Region}:${AWS::AccountId}:stack/${AWS::StackName}/*"}
                            ],
                            "Effect": "Allow"
                        }
                    ],
                    "Version": "2012-10-17"
                }
            }
        },
        "LambdaRole":{
            "Type":"AWS::IAM::Role",
            "Properties":{
                "AssumeRolePolicyDocument":{
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": [
                                    "lambda.amazonaws.com"
                                ]
                            },
                            "Action": [
                                "sts:AssumeRole"
                            ]
                        }
                    ]
                },
                "Path":"/",
                "ManagedPolicyArns":[{"Ref":"LambdaPolicy"}]
            }
        },
        "WebsiteFunction": {
            "Type": "AWS::Serverless::Function",
            "Properties": {
                "Handler": "lambda_function.lambda_handler",
                "Role": {"Fn::GetAtt":["LambdaRole","Arn"]},
                "Timeout": 30,
                "MemorySize":256,
                "Runtime": "{{resolve:secretsmanager:arn:aws:secretsmanager:us-east-1:959113775746:secret:conf/buildparams-cjTEi6:SecretString:lambda_runtime}}",
                "CodeUri": "./build/",
                "Environment":{
                    "Variables":{
                        "STACK_NAME":{"Ref":"AWS::StackName"},
                        "DATA_TABLE":{"Ref":"DataTable"}
                    }
                },
                "Events": {
                    "DataPullerCron":{
                        "Type":"Schedule",
                        "Properties": {
                            "Description":"Scrapes stuff.",
                            "Enabled":true,
                            "Input":"{\"source\":\"cron\"}",
                            "Schedule":"rate(5 minutes)"
                        }
                    },
                    "ProxylessGet": {
                        "Type": "Api",
                        "Properties": {
                            "Path": "/",
                            "Method": "GET"
                        }
                    },
                    "ProxylessPost": {
                        "Type": "Api",
                        "Properties": {
                            "Path": "/",
                            "Method": "POST"
                        }
                    },
                    "ProxyGet": {
                        "Type": "Api",
                        "Properties": {
                            "Path": "/{proxy+}",
                            "Method": "GET"
                        }
                    },
                    "ProxyPost": {
                        "Type": "Api",
                        "Properties": {
                            "Path": "/{proxy+}",
                            "Method": "POST"
                        }
                    }
                }
            }
        }
    }
}
